<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OMR Camera Overlay</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #000;
        font-family: Arial, sans-serif;
        overflow: hidden;
      }

      .camera-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 3px solid #00ff00;
        background: transparent;
        pointer-events: none;
        z-index: 10;
      }

      .corner-marker {
        position: absolute;
        width: 30px;
        height: 30px;
        border: 4px solid #00ff00;
        background: transparent;
      }

      .corner-top-left {
        top: -4px;
        left: -4px;
        border-right: none;
        border-bottom: none;
      }

      .corner-top-right {
        top: -4px;
        right: -4px;
        border-left: none;
        border-bottom: none;
      }

      .corner-bottom-left {
        bottom: -4px;
        left: -4px;
        border-right: none;
        border-top: none;
      }

      .corner-bottom-right {
        bottom: -4px;
        right: -4px;
        border-left: none;
        border-top: none;
      }

      .bubble-guide {
        position: absolute;
        border: 2px solid #ffff00;
        border-radius: 50%;
        background: transparent;
        pointer-events: none;
      }

      .instructions {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        border-radius: 8px;
        z-index: 20;
        max-width: 300px;
      }

      .instructions h3 {
        margin: 0 0 10px 0;
        color: #00ff00;
      }

      .instructions p {
        margin: 5px 0;
        font-size: 14px;
      }

      .capture-button {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #00ff00;
        color: #000;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 25px;
        cursor: pointer;
        z-index: 20;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .capture-button:hover {
        background: #00cc00;
      }

      .capture-button:active {
        background: #009900;
      }

      .status {
        position: absolute;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        z-index: 20;
        font-size: 14px;
      }

      .error {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 0, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        z-index: 30;
      }

      .captured-image {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 80%;
        max-height: 80%;
        border: 3px solid #00ff00;
        z-index: 25;
      }
    </style>
  </head>
  <body>
    <div class="camera-container">
      <video id="video" autoplay muted playsinline></video>

      <div class="overlay" id="overlay">
        <div class="corner-marker corner-top-left"></div>
        <div class="corner-marker corner-top-right"></div>
        <div class="corner-marker corner-bottom-left"></div>
        <div class="corner-marker corner-bottom-right"></div>
        <div id="bubble-guides"></div>
      </div>

      <div class="instructions">
        <h3>üì± OMR Camera Guide</h3>
        <p>1. Align your OMR sheet within the green frame</p>
        <p>2. Make sure all corners are visible</p>
        <p>3. Ensure good lighting (no shadows)</p>
        <p>4. Click CAPTURE when ready</p>
      </div>

      <button class="capture-button" id="captureBtn">üì∏ CAPTURE</button>
      <div class="status" id="status">Ready to capture</div>

      <!-- Demo mode button (hidden by default) -->
      <button
        id="demoBtn"
        style="
          display: none;
          position: absolute;
          top: 20px;
          right: 20px;
          background: #ff6b6b;
          color: white;
          border: none;
          padding: 10px 15px;
          border-radius: 20px;
          cursor: pointer;
          z-index: 30;
        "
      >
        üé≠ Demo Mode
      </button>
    </div>

    <script>
      class OMRCameraOverlay {
        constructor() {
          this.video = document.getElementById('video');
          this.overlay = document.getElementById('overlay');
          this.captureBtn = document.getElementById('captureBtn');
          this.status = document.getElementById('status');
          this.bubbleGuides = document.getElementById('bubble-guides');
          this.demoBtn = document.getElementById('demoBtn');

          // OMR template dimensions (from your template.json)
          this.templateWidth = 707;
          this.templateHeight = 484;
          this.bubbleWidth = 15;
          this.bubbleHeight = 10;

          // Default field blocks configuration - matches your template.json exactly
          this.fieldBlocks = {
            Column1: {
              fieldType: 'QTYPE_MCQ4',
              origin: [82, 35],
              labelsGap: 22.7,
              bubblesGap: 21,
              bubbleCount: 20,
              fieldLabels: [
                'Q1',
                'Q2',
                'Q3',
                'Q4',
                'Q5',
                'Q6',
                'Q7',
                'Q8',
                'Q9',
                'Q10',
                'Q11',
                'Q12',
                'Q13',
                'Q14',
                'Q15',
                'Q16',
                'Q17',
                'Q18',
                'Q19',
                'Q20'
              ],
              label: 'Column1'
            },
            Column2: {
              fieldType: 'QTYPE_MCQ4',
              origin: [205, 35],
              labelsGap: 22.7,
              bubblesGap: 21,
              bubbleCount: 20,
              fieldLabels: [
                'Q21',
                'Q22',
                'Q23',
                'Q24',
                'Q25',
                'Q26',
                'Q27',
                'Q28',
                'Q29',
                'Q30',
                'Q31',
                'Q32',
                'Q33',
                'Q34',
                'Q35',
                'Q36',
                'Q37',
                'Q38',
                'Q39',
                'Q40'
              ],
              label: 'Column2'
            },
            Column3: {
              fieldType: 'QTYPE_MCQ4',
              origin: [327, 35],
              labelsGap: 22.7,
              bubblesGap: 21,
              bubbleCount: 20,
              fieldLabels: [
                'Q41',
                'Q42',
                'Q43',
                'Q44',
                'Q45',
                'Q46',
                'Q47',
                'Q48',
                'Q49',
                'Q50',
                'Q51',
                'Q52',
                'Q53',
                'Q54',
                'Q55',
                'Q56',
                'Q57',
                'Q58',
                'Q59',
                'Q60'
              ],
              label: 'Column3'
            },
            Column4: {
              fieldType: 'QTYPE_MCQ4',
              origin: [450, 35],
              labelsGap: 22.7,
              bubblesGap: 21,
              bubbleCount: 20,
              fieldLabels: [
                'Q61',
                'Q62',
                'Q63',
                'Q64',
                'Q65',
                'Q66',
                'Q67',
                'Q68',
                'Q69',
                'Q70',
                'Q71',
                'Q72',
                'Q73',
                'Q74',
                'Q75',
                'Q76',
                'Q77',
                'Q78',
                'Q79',
                'Q80'
              ],
              label: 'Column4'
            },
            Column5: {
              fieldType: 'QTYPE_MCQ4',
              origin: [573, 35],
              labelsGap: 22.7,
              bubblesGap: 21,
              bubbleCount: 20,
              fieldLabels: [
                'Q81',
                'Q82',
                'Q83',
                'Q84',
                'Q85',
                'Q86',
                'Q87',
                'Q88',
                'Q89',
                'Q90',
                'Q91',
                'Q92',
                'Q93',
                'Q94',
                'Q95',
                'Q96',
                'Q97',
                'Q98',
                'Q99',
                'Q100'
              ],
              label: 'Column5'
            }
          };

          this.captureCount = 0;
          this.stream = null;

          this.init();
        }

        async init() {
          try {
            await this.loadTemplate();
            await this.startCamera();
            this.setupOverlay();
            this.drawBubbleGuides();
            this.setupEventListeners();
          } catch (error) {
            this.showError('Camera access denied or not available');
          }
        }

        async loadTemplate() {
          try {
            // Try to load template from your actual template.json
            const response = await fetch('inputs/dxuian/template.json');
            if (response.ok) {
              const template = await response.json();
              this.templateWidth = template.pageDimensions[0];
              this.templateHeight = template.pageDimensions[1];
              this.bubbleWidth = template.bubbleDimensions[0];
              this.bubbleHeight = template.bubbleDimensions[1];

              // Update field blocks from template with EXACT fieldLabels
              this.fieldBlocks = {};
              Object.keys(template.fieldBlocks).forEach(key => {
                const block = template.fieldBlocks[key];
                this.fieldBlocks[key] = {
                  origin: block.origin,
                  labelsGap: block.labelsGap,
                  bubblesGap: block.bubblesGap,
                  fieldLabels: block.fieldLabels, // Use exact field labels from template
                  bubbleCount: block.bubbleCount,
                  fieldType: block.fieldType,
                  label: key
                };
              });

              console.log('Template loaded successfully:', template);
              console.log('Field blocks configured:', this.fieldBlocks);
            } else {
              console.log('Using default template configuration');
            }
          } catch (error) {
            console.log('Could not load template.json, using defaults:', error);
          }
        }

        async startCamera() {
          const constraints = {
            video: {
              width: { ideal: 1280 },
              height: { ideal: 720 },
              facingMode: 'environment' // Use back camera on mobile
            }
          };

          this.stream = await navigator.mediaDevices.getUserMedia(constraints);
          this.video.srcObject = this.stream;

          return new Promise(resolve => {
            this.video.onloadedmetadata = () => {
              resolve();
            };
          });
        }

        startDemoMode() {
          // Create a demo background instead of camera feed
          this.video.style.display = 'none';

          // Create demo background
          const demoBackground = document.createElement('div');
          demoBackground.id = 'demo-background';
          demoBackground.style.position = 'absolute';
          demoBackground.style.top = '0';
          demoBackground.style.left = '0';
          demoBackground.style.width = '100%';
          demoBackground.style.height = '100%';
          demoBackground.style.background =
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          demoBackground.style.zIndex = '1';

          // Add demo text
          const demoText = document.createElement('div');
          demoText.style.position = 'absolute';
          demoText.style.top = '50%';
          demoText.style.left = '50%';
          demoText.style.transform = 'translate(-50%, -50%)';
          demoText.style.color = 'white';
          demoText.style.fontSize = '24px';
          demoText.style.fontWeight = 'bold';
          demoText.style.textAlign = 'center';
          demoText.style.zIndex = '2';
          demoText.innerHTML = `
            üì± <br>
            Camera Demo Mode <br>
            <small style="font-size: 16px; opacity: 0.8;">
              Camera not available - showing overlay layout<br>
              When camera is ready, refresh the page
            </small>
          `;

          demoBackground.appendChild(demoText);
          document
            .querySelector('.camera-container')
            .appendChild(demoBackground);

          // Update instructions
          const instructions = document.querySelector('.instructions');
          instructions.innerHTML = `
            <h3>üì± OMR Camera Guide - Demo Mode</h3>
            <p>‚úÖ Overlay layout is ready</p>
            <p>‚ö†Ô∏è Camera not available</p>
            <p>üîÑ Refresh page when camera is ready</p>
            <p>üì∏ Then click CAPTURE to take photos</p>
          `;

          // Update status
          this.status.textContent = 'Demo Mode - Camera not available';
          this.captureBtn.textContent = 'üì∑ Enable Camera';
          this.captureBtn.onclick = () => {
            location.reload(); // Reload to try camera again
          };

          // Set demo video dimensions for overlay calculation
          this.video.videoWidth = 1280;
          this.video.videoHeight = 720;
          this.calculateOverlaySize();
        }

        setupOverlay() {
          // Wait for video to load, then calculate overlay size
          this.video.addEventListener('loadedmetadata', () => {
            this.calculateOverlaySize();
          });
        }

        calculateOverlaySize() {
          const videoWidth = this.video.videoWidth;
          const videoHeight = this.video.videoHeight;

          // Calculate overlay size (80% of video height for good fit)
          const overlayHeight = Math.floor(videoHeight * 0.8);
          const overlayWidth = Math.floor(
            overlayHeight * (this.templateWidth / this.templateHeight)
          );

          // Apply scaling
          this.scaleX = overlayWidth / this.templateWidth;
          this.scaleY = overlayHeight / this.templateHeight;

          // Set overlay size
          this.overlay.style.width = overlayWidth + 'px';
          this.overlay.style.height = overlayHeight + 'px';

          console.log(`Overlay size: ${overlayWidth}x${overlayHeight}`);
          console.log(
            `Scale factors: ${this.scaleX.toFixed(2)}, ${this.scaleY.toFixed(
              2
            )}`
          );
        }

        drawBubbleGuides() {
          // Clear existing guides
          this.bubbleGuides.innerHTML = '';

          // Draw sample bubbles from each column with question numbers
          const sampleQuestions = [0, 4, 9, 14, 19]; // Sample question indices (0-based)

          Object.keys(this.fieldBlocks).forEach((colName, colIndex) => {
            const colConfig = this.fieldBlocks[colName];
            const colX = colConfig.origin[0] * this.scaleX;
            const colY = colConfig.origin[1] * this.scaleY;

            // Draw column label
            const colLabel = document.createElement('div');
            colLabel.style.position = 'absolute';
            colLabel.style.left = colX + 'px';
            colLabel.style.top = colY - 20 + 'px';
            colLabel.style.color = '#00ff00';
            colLabel.style.fontSize = '12px';
            colLabel.style.fontWeight = 'bold';
            colLabel.style.background = 'rgba(0,0,0,0.7)';
            colLabel.style.padding = '2px 5px';
            colLabel.style.borderRadius = '3px';
            // Use exact fieldLabels from template
            if (colConfig.fieldLabels && colConfig.fieldLabels.length > 0) {
              const firstQ = colConfig.fieldLabels[0];
              const lastQ =
                colConfig.fieldLabels[colConfig.fieldLabels.length - 1];
              colLabel.textContent = `${firstQ}-${lastQ}`;
            } else {
              colLabel.textContent = colConfig.label;
            }
            this.bubbleGuides.appendChild(colLabel);

            sampleQuestions.forEach(questionIdx => {
              // Use EXACT fieldLabels from template
              let questionLabel = '';
              if (colConfig.fieldLabels && colConfig.fieldLabels[questionIdx]) {
                questionLabel = colConfig.fieldLabels[questionIdx]; // Use exact label like "Q1", "Q6", "Q11"
              } else {
                questionLabel = `Q${questionIdx + 1}`;
              }

              const questionY =
                colY + questionIdx * colConfig.labelsGap * this.scaleY;
              const bubbleRadius = (this.bubbleHeight * this.scaleY) / 2;

              // Draw question number using exact fieldLabel
              const questionLabelDiv = document.createElement('div');
              questionLabelDiv.style.position = 'absolute';
              questionLabelDiv.style.left = colX - 30 + 'px';
              questionLabelDiv.style.top = questionY - 5 + 'px';
              questionLabelDiv.style.color = '#ffffff';
              questionLabelDiv.style.fontSize = '10px';
              questionLabelDiv.style.fontWeight = 'bold';
              questionLabelDiv.style.background = 'rgba(0,0,0,0.7)';
              questionLabelDiv.style.padding = '1px 3px';
              questionLabelDiv.style.borderRadius = '2px';
              questionLabelDiv.textContent = questionLabel;
              this.bubbleGuides.appendChild(questionLabelDiv);

              // Get bubble values from fieldType or custom bubbleValues
              let bubbleValues = ['A', 'B', 'C', 'D']; // Default fallback
              if (colConfig.bubbleValues) {
                bubbleValues = colConfig.bubbleValues;
              } else if (colConfig.fieldType) {
                // Use fieldType to get bubble values
                if (colConfig.fieldType === 'QTYPE_MCQ4') {
                  bubbleValues = ['A', 'B', 'C', 'D'];
                } else if (colConfig.fieldType === 'QTYPE_MCQ5') {
                  bubbleValues = ['A', 'B', 'C', 'D', 'E'];
                } else if (colConfig.fieldType === 'QTYPE_INT') {
                  bubbleValues = [
                    '0',
                    '1',
                    '2',
                    '3',
                    '4',
                    '5',
                    '6',
                    '7',
                    '8',
                    '9'
                  ];
                } else if (colConfig.fieldType === 'QTYPE_INT_FROM_1') {
                  bubbleValues = [
                    '1',
                    '2',
                    '3',
                    '4',
                    '5',
                    '6',
                    '7',
                    '8',
                    '9',
                    '0'
                  ];
                }
              }

              // Get direction (horizontal/vertical)
              const direction = colConfig.direction || 'horizontal';

              // Draw bubbles using exact bubbleValues and direction
              bubbleValues.forEach((optionValue, optionIdx) => {
                let optionX,
                  optionY = questionY;

                if (direction === 'horizontal') {
                  optionX =
                    colX + optionIdx * colConfig.bubblesGap * this.scaleX;
                } else {
                  // vertical
                  optionX = colX;
                  optionY =
                    colY +
                    (questionIdx * bubbleValues.length + optionIdx) *
                      colConfig.bubblesGap *
                      this.scaleY;
                }

                const bubble = document.createElement('div');
                bubble.className = 'bubble-guide';
                bubble.style.left = optionX - bubbleRadius + 'px';
                bubble.style.top = optionY - bubbleRadius + 'px';
                bubble.style.width = bubbleRadius * 2 + 'px';
                bubble.style.height = bubbleRadius * 2 + 'px';

                // Add option label using exact bubble value
                const optionLabel = document.createElement('div');
                optionLabel.style.position = 'absolute';
                optionLabel.style.left = optionX - 3 + 'px';
                optionLabel.style.top = optionY + bubbleRadius + 2 + 'px';
                optionLabel.style.color = '#ffff00';
                optionLabel.style.fontSize = '8px';
                optionLabel.style.fontWeight = 'bold';
                optionLabel.style.background = 'rgba(0,0,0,0.7)';
                optionLabel.style.padding = '1px';
                optionLabel.style.borderRadius = '1px';
                optionLabel.textContent = optionValue;
                optionLabel.style.pointerEvents = 'none';

                bubble.appendChild(optionLabel);
                this.bubbleGuides.appendChild(bubble);
              });
            });
          });
        }

        setupEventListeners() {
          this.captureBtn.addEventListener('click', () => {
            this.captureImage();
          });

          // Demo button (for testing without camera)
          this.demoBtn.addEventListener('click', () => {
            this.startDemoMode();
          });

          // Show demo button after 3 seconds if camera fails
          setTimeout(() => {
            if (
              this.video.srcObject === null ||
              this.video.srcObject === undefined
            ) {
              this.demoBtn.style.display = 'block';
            }
          }, 3000);

          // Handle window resize
          window.addEventListener('resize', () => {
            setTimeout(() => {
              this.calculateOverlaySize();
              this.drawBubbleGuides();
            }, 100);
          });
        }

        captureImage() {
          this.status.textContent = 'Capturing...';
          this.captureBtn.disabled = true;

          // Create canvas to capture image
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          // Set canvas size to video size
          canvas.width = this.video.videoWidth;
          canvas.height = this.video.videoHeight;

          // Draw video frame to canvas
          ctx.drawImage(this.video, 0, 0, canvas.width, canvas.height);

          // Calculate crop area (overlay region)
          const overlayRect = this.overlay.getBoundingClientRect();
          const videoRect = this.video.getBoundingClientRect();

          // Convert overlay position to video coordinates
          const scaleX = this.video.videoWidth / videoRect.width;
          const scaleY = this.video.videoHeight / videoRect.height;

          const cropX = (overlayRect.left - videoRect.left) * scaleX;
          const cropY = (overlayRect.top - videoRect.top) * scaleY;
          const cropWidth = overlayRect.width * scaleX;
          const cropHeight = overlayRect.height * scaleY;

          // Create cropped canvas
          const croppedCanvas = document.createElement('canvas');
          const croppedCtx = croppedCanvas.getContext('2d');

          // Set cropped canvas size to template dimensions
          croppedCanvas.width = this.templateWidth;
          croppedCanvas.height = this.templateHeight;

          // Draw cropped and resized image
          croppedCtx.drawImage(
            canvas,
            cropX,
            cropY,
            cropWidth,
            cropHeight,
            0,
            0,
            this.templateWidth,
            this.templateHeight
          );

          // Convert to blob and download
          croppedCanvas.toBlob(
            blob => {
              this.downloadImage(blob);
              this.showCapturedImage(croppedCanvas);
            },
            'image/jpeg',
            0.9
          );

          this.captureCount++;
          this.status.textContent = `Captured ${this.captureCount} images`;
          this.captureBtn.disabled = false;
        }

        downloadImage(blob) {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `omr_captured_${this.captureCount
            .toString()
            .padStart(3, '0')}.jpg`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          console.log(
            `Image saved: omr_captured_${this.captureCount
              .toString()
              .padStart(3, '0')}.jpg`
          );
        }

        showCapturedImage(canvas) {
          // Show captured image briefly
          const img = document.createElement('img');
          img.src = canvas.toDataURL();
          img.className = 'captured-image';

          document.body.appendChild(img);

          setTimeout(() => {
            document.body.removeChild(img);
          }, 2000);
        }

        showError(message) {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error';
          errorDiv.innerHTML = `
                    <h3>‚ö†Ô∏è Error</h3>
                    <p>${message}</p>
                    <p>Please allow camera access and refresh the page</p>
                `;
          document.body.appendChild(errorDiv);
        }

        stop() {
          if (this.stream) {
            this.stream.getTracks().forEach(track => track.stop());
          }
        }
      }

      // Initialize when page loads
      document.addEventListener('DOMContentLoaded', () => {
        new OMRCameraOverlay();
      });

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (window.omrCamera) {
          window.omrCamera.stop();
        }
      });
    </script>
  </body>
</html>
